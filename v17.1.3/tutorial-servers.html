<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Tutorial: servers - ActionHero Documentation</title>
    
    <meta name="description" content="Documentation for the ActionHero.js Node.js framework" />
    
        <meta name="keywords" content="ActionHero Node Framework Docs Documentation" />
        <meta name="keyword" content="ActionHero Node Framework Docs Documentation" />
    
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://actionherojs.com" target="_blank" class="menu-item" id="website_link" >Main Website</a></h2><h2><a href="https://slack.actionherojs.com" target="_blank" class="menu-item" id="forum_link" >Slack</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-action-cluster.html">action-cluster</a></li><li><a href="tutorial-actions.html">actions</a></li><li><a href="tutorial-cli.html">cli</a></li><li><a href="tutorial-config.html">config</a></li><li><a href="tutorial-development-mode.html">development-mode</a></li><li><a href="tutorial-file-server.html">file-server</a></li><li><a href="tutorial-initializers.html">initializers</a></li><li><a href="tutorial-localization.html">localization</a></li><li><a href="tutorial-logging.html">logging</a></li><li><a href="tutorial-middleware.html">middleware</a></li><li><a href="tutorial-plugins.html">plugins</a></li><li><a href="tutorial-production-notes.html">production-notes</a></li><li><a href="tutorial-running-actionhero.html">running-actionhero</a></li><li><a href="tutorial-servers.html">servers</a></li><li><a href="tutorial-socket.html">socket</a></li><li><a href="tutorial-tasks.html">tasks</a></li><li><a href="tutorial-testing.html">testing</a></li><li><a href="tutorial-upgrade-path.html">upgrade-path</a></li><li><a href="tutorial-utils.html">utils</a></li><li><a href="tutorial-web.html">web</a></li><li><a href="tutorial-websocket.html">websocket</a></li></ul><h3>Namespaces</h3><ul><li><a href="api.actions.html">actions</a><ul class='methods'><li data-type='method' style='display: none;'><a href="api.actions.html#.addMiddleware">addMiddleware</a></li></ul></li><li><a href="api.cache.html">cache</a><ul class='methods'><li data-type='method' style='display: none;'><a href="api.cache.html#.clear">clear</a></li><li data-type='method' style='display: none;'><a href="api.cache.html#.destroy">destroy</a></li><li data-type='method' style='display: none;'><a href="api.cache.html#.dumpRead">dumpRead</a></li><li data-type='method' style='display: none;'><a href="api.cache.html#.dumpWrite">dumpWrite</a></li><li data-type='method' style='display: none;'><a href="api.cache.html#.keys">keys</a></li><li data-type='method' style='display: none;'><a href="api.cache.html#.listLength">listLength</a></li><li data-type='method' style='display: none;'><a href="api.cache.html#.load">load</a></li><li data-type='method' style='display: none;'><a href="api.cache.html#.lock">lock</a></li><li data-type='method' style='display: none;'><a href="api.cache.html#.locks">locks</a></li><li data-type='method' style='display: none;'><a href="api.cache.html#.pop">pop</a></li><li data-type='method' style='display: none;'><a href="api.cache.html#.push">push</a></li><li data-type='method' style='display: none;'><a href="api.cache.html#.save">save</a></li><li data-type='method' style='display: none;'><a href="api.cache.html#.size">size</a></li><li data-type='method' style='display: none;'><a href="api.cache.html#.unlock">unlock</a></li></ul></li><li><a href="api.chatRoom.html">chatRoom</a><ul class='methods'><li data-type='method' style='display: none;'><a href="api.chatRoom.html#.add">add</a></li><li data-type='method' style='display: none;'><a href="api.chatRoom.html#.addMember">addMember</a></li><li data-type='method' style='display: none;'><a href="api.chatRoom.html#.addMiddleware">addMiddleware</a></li><li data-type='method' style='display: none;'><a href="api.chatRoom.html#.broadcast">broadcast</a></li><li data-type='method' style='display: none;'><a href="api.chatRoom.html#.destroy">destroy</a></li><li data-type='method' style='display: none;'><a href="api.chatRoom.html#.exists">exists</a></li><li data-type='method' style='display: none;'><a href="api.chatRoom.html#.generateMemberDetails">generateMemberDetails</a></li><li data-type='method' style='display: none;'><a href="api.chatRoom.html#.list">list</a></li><li data-type='method' style='display: none;'><a href="api.chatRoom.html#.removeMember">removeMember</a></li><li data-type='method' style='display: none;'><a href="api.chatRoom.html#.roomStatus">roomStatus</a></li><li data-type='method' style='display: none;'><a href="api.chatRoom.html#.sanitizeMemberDetails">sanitizeMemberDetails</a></li></ul></li><li><a href="api.config.html">config</a></li><li><a href="api.connections.html">connections</a><ul class='methods'><li data-type='method' style='display: none;'><a href="api.connections.html#.addMiddleware">addMiddleware</a></li><li data-type='method' style='display: none;'><a href="api.connections.html#.apply">apply</a></li></ul></li><li><a href="api.documentation.html">documentation</a></li><li><a href="api.exceptions.html">exceptions</a></li><li><a href="api.i18n.html">i18n</a><ul class='methods'><li data-type='method' style='display: none;'><a href="api.i18n.html#.localize">localize</a></li></ul></li><li><a href="api.id.html">id</a></li><li><a href="api.params.html">params</a></li><li><a href="api.pids.html">pids</a></li><li><a href="api.redis.html">redis</a><ul class='methods'><li data-type='method' style='display: none;'><a href="api.redis.html#.doCluster">doCluster</a></li></ul></li><li><a href="api.resque.html">resque</a></li><li><a href="api.routes.html">routes</a><ul class='methods'><li data-type='method' style='display: none;'><a href="api.routes.html#.registerRoute">registerRoute</a></li></ul></li><li><a href="api.servers.html">servers</a></li><li><a href="api.specHelper.html">specHelper</a><ul class='methods'><li data-type='method' style='display: none;'><a href="api.specHelper.html#.connection">connection</a></li><li data-type='method' style='display: none;'><a href="api.specHelper.html#.getStaticFile">getStaticFile</a></li><li data-type='method' style='display: none;'><a href="api.specHelper.html#.runAction">runAction</a></li><li data-type='method' style='display: none;'><a href="api.specHelper.html#.runFullTask">runFullTask</a></li><li data-type='method' style='display: none;'><a href="api.specHelper.html#.runTask">runTask</a></li></ul></li><li><a href="api.staticFile.html">staticFile</a><ul class='methods'><li data-type='method' style='display: none;'><a href="api.staticFile.html#.get">get</a></li></ul></li><li><a href="api.tasks.html">tasks</a><ul class='methods'><li data-type='method' style='display: none;'><a href="api.tasks.html#.allDelayed">allDelayed</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.allWorkingOn">allWorkingOn</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.cleanOldWorkers">cleanOldWorkers</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.del">del</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.delayedAt">delayedAt</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.delDelayed">delDelayed</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.delLock">delLock</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.delQueue">delQueue</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.details">details</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.enqueue">enqueue</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.enqueueAllRecurrentJobs">enqueueAllRecurrentJobs</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.enqueueAt">enqueueAt</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.enqueueIn">enqueueIn</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.enqueueRecurrentJob">enqueueRecurrentJob</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.failed">failed</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.failedCount">failedCount</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.locks">locks</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.queued">queued</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.removeFailed">removeFailed</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.retryAndRemoveFailed">retryAndRemoveFailed</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.scheduledAt">scheduledAt</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.stats">stats</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.stopRecurrentJob">stopRecurrentJob</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.timestamps">timestamps</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.workers">workers</a></li><li data-type='method' style='display: none;'><a href="api.tasks.html#.workingOn">workingOn</a></li></ul></li><li><a href="api.utils.html">utils</a><ul class='methods'><li data-type='method' style='display: none;'><a href="api.utils.html#.arrayUniqueify">arrayUniqueify</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.collapseObjectToArray">collapseObjectToArray</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.createDirSafely">createDirSafely</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.createFileSafely">createFileSafely</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.createLinkfileSafely">createLinkfileSafely</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.createSymlinkSafely">createSymlinkSafely</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.dirExists">dirExists</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.eventLoopDelay">eventLoopDelay</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.fileExists">fileExists</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.filterObjectForLogging">filterObjectForLogging</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.getExternalIPAddress">getExternalIPAddress</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.hashMerge">hashMerge</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.parseCookies">parseCookies</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.parseIPv6URI">parseIPv6URI</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.removeLinkfileSafely">removeLinkfileSafely</a></li><li data-type='method' style='display: none;'><a href="api.utils.html#.sortGlobalMiddleware">sortGlobalMiddleware</a></li></ul></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">Tutorial: servers</h1>
    

    <section>

<header>
    

    <h2>servers</h2>
</header>

<article>
    <h2>Overview</h2><pre class="prettyprint source lang-js"><code>var initialize = function(api, options, next){

  //////////
  // INIT //
  //////////

  var type = &quot;test&quot;
  var attributes = {
    canChat: true,
    logConnections: true,
    logExits: true,
    sendWelcomeMessage: true,
    verbs: [],
  }

  var server = new api.GenericServer(type, options, attributes);

  //////////////////////
  // REQUIRED METHODS //
  //////////////////////

  server.start = function(next){}

  server.stop = function(next){}

  server.sendMessage = function(connection, message, messageCount){}

  server.sendFile = function(connection, error, fileStream, mime, length){};

  server.goodbye = function(connection, reason){};

  ////////////
  // EVENTS //
  ////////////

  server.on(&quot;connection&quot;, function(connection){});

  server.on('actionComplete', function(data){
    completeResponse(data);
  });

  /////////////
  // HELPERS //
  /////////////

  next(server);
}

/////////////////////////////////////////////////////////////////////
// exports
exports.initialize = initialize;</code></pre><p>In ActionHero v6.0.0 and later, we have introduced a modular server system which allows you to create your own servers.  Servers should be thought of as any type of listener to clients, streams or your file system.  In ActionHero, the goal of each server is to ingest a specific type of connection and transform each client into a generic <code>connection</code> object which can be operated on by the rest of ActionHero.  To help with this, all servers extend <code>api.GenericServer</code> and fill in the required methods.
To get started, you can use the <code>generateServer action</code> (name is required).  This will generate a template server which looks like the above.
Like initializers, the <code>start()</code> and <code>stop()</code> methods will be called when the server is to boot up in ActionHero's lifecycle, but before any clients are permitted into the system.  Here is where you should actually initialize your server (IE: <code>https.createServer.listen</code>, etc).</p>
<h2>Designing Servers</h2><p>Your job, as a server designer, is to coerce every client's connection into a connection object.  This is done with the <code>sever.buildConnection</code> helper.  Here is an example from the <code>web</code> server:</p>
<pre class="prettyprint source lang-js"><code>server.buildConnection({
  rawConnection: {
    req: req,
    res: res,
    method: method,
    cookies: cookies,
    responseHeaders: responseHeaders,
    responseHttpCode: responseHttpCode,
    parsedURL: parsedURL
  },
  id: randomNumber(),
  remoteAddress: remoteIP,
  remotePort: req.connection.remotePort}
); // will emit &quot;connection&quot;

// Note that connections will have a \`rawConnection\` property.  This is where you should store the actual object(s) returned by your server so that you can use them to communicate back with the client.  Again, an example from the \`web\` server:

server.sendMessage = function(connection, message){
   cleanHeaders(connection);
   var headers = connection.rawConnection.responseHeaders;
   var responseHttpCode = parseInt(connection.rawConnection.responseHttpCode);
   var stringResponse = String(message)
   connection.rawConnection.res.writeHead(responseHttpCode, headers);
   connection.rawConnection.res.end(stringResponse);
   server.destroyConnection(connection);
 }</code></pre><h2>Options and Attributes</h2><p>A server defines <code>attributes</code> which define it's behavior.  Variables like <code>canChat</code> are defined here. <code>options</code> are passed in, and come from <code>api.config.servers[serverName]</code>.  These can be new variables (like https?) or they can also overwrite the set <code>attributes</code>.
The required attributes are provided in a generated server.</p>
<h2>Verbs</h2><pre class="prettyprint source lang-js"><code>allowedVerbs: [
      &quot;quit&quot;,
      &quot;exit&quot;,
      &quot;paramAdd&quot;,
      &quot;paramDelete&quot;,
      &quot;paramView&quot;,
      &quot;paramsView&quot;,
      &quot;paramsDelete&quot;,
      &quot;roomChange&quot;,
      &quot;roomView&quot;,
      &quot;listenToRoom&quot;,
      &quot;silenceRoom&quot;,
      &quot;detailsView&quot;,
      &quot;say&quot;
    ]</code></pre><p>When an incoming message is detected, it is the server's job to build <code>connection.params</code>.  In the <code>web</code> server, this is accomplished by reading GET, POST, and form data.  For <code>websocket</code> clients, that information is expected to be emitted as part of the action's request.  For other clients, like <code>socket</code>, ActionHero provides helpers for long-lasting clients to operate on themselves.  These are called connection <code>verbs</code>.
Clients use verbs to add params to themselves, update the chat room they are in, and more.   The list of verbs currently supported is listed above.
Your server should be smart enough to tell when a client is trying to run an action, request a file, or use a verb.  One of the attributes of each server is <code>allowedVerbs</code>, which defines what verbs a client is allowed to preform.  A simplified example of how the <code>socket</code> server does this:</p>
<pre class="prettyprint source lang-js"><code>var parseRequest = function(connection, line){
   var words = line.split(&quot; &quot;);
   var verb = words.shift();
   if(verb == &quot;file&quot;){
     if (words.length > 0){
       connection.params.file = words[0];
     }
     server.processFile(connection);
   }else{
     connection.verbs(verb, words, function(error, data){
       if(error == null){
         var message = {status: &quot;OK&quot;, context: &quot;response&quot;, data: data}
         server.sendMessage(connection, message);
       }else if(error === &quot;verb not found or not allowed&quot;){
         connection.error = null;
         connection.response = {};
         server.processAction(connection);
       }else{
         var message = {status: error, context: &quot;response&quot;, data: data}
         server.sendMessage(connection, message);
       }
     });
   }
 }</code></pre><h2>Chat</h2><p>The <code>attribute</code> &quot;canChat&quot; defines if clients of this server can chat.  If clients can chat, they should be allowed to use vebs like &quot;roomChange&quot; and &quot;say&quot;.  They will also be sent messages in their room (and rooms they are listening too) automatically.</p>
<h2>Sending Responses</h2><p>All servers need to implement the <code>server.sendMessage = function(connection, message, messageCount)</code> method so ActionHero knows how to talk to each client.  This is likely to make use of <code>connection.rawConnection</code>.  If you are writing a server for a persistent connection, it is likely you will need to respond with <code>messageCount</code> so that the client knows which request your response is about (as they are not always going to get the responses in order).</p>
<h2>Sending Files</h2><p>Servers can optionally implement the <code>server.sendFile = function(connection, error, fileStream, mime, length)</code> method.  This method is responsible for any connection-specific file transport (headers, chinking, encoding, etc). Note that fileStream is a <code>stream</code> which should be <code>pipe</code>'d to the client.</p>
<h2>Customizing Servers</h2><pre class="prettyprint source lang-js"><code>//Initializer
 module.exports = {
   startPriority: 1000,
   start: function (api, next) {
     let webServer = api.servers.servers.web
     webServer.connectionCustomMethods = webServer.connectionCustomMethods || {}
     webServer.connectionCustomMethods.requestHeaders = function (connection) {
       return connection.rawConnection.req.headers
     }
   }
 }

 //Action
 module.exports = {
   name: 'logHeaders',
   description 'Log Web Request Headers',
   run: function (api, data, next) {
     let headers = data.connection.requestHeaders()
     api.log('Headers:', 'debug', headers)
     next()
   }
 }</code></pre><p>The <code>connection</code> object passed to a server can be customized on a per server basis through the use of the <code>server.connectionCustomMethods</code> hash. The hash can be populated with functions whose signature must match <code>function (connection, ...)</code>. Once populated, these functions are curried to always pass <code>connection</code> as the first argument and applied to the <code>data.connection</code> object passed to Actions, and can be accessed via <code>data.connection.functionName(...)</code> within the action or middleware.
In this way, you can create custom methods on your connections.</p>
</article>

</section>

    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/jquery-3.1.1.min.js"></script>


<script src="scripts/collapse.js"></script>



    <script src="scripts/logo.js"></script>
    
    <script src="scripts/style.js"></script>
    
    <script src="scripts/VERSIONS.js"></script>
    
    <script src="scripts/version-navigation.js"></script>
    
    <script src="scripts/google-analytics.js"></script>
    
</body>
</html>